{% load static %}
<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Dashboard utilizator - Fii Verde</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script defer src="{% static 'js/dashboard.js' %}"></script>
</head>
<body>
<header>
    <div class="logo">ðŸŒ¿ Fii Verde</div>
    <nav>
        <ul class="nav-links">
            <li><a href="/">AcasÄƒ</a></li>
            <li><a href="/despre">Despre</a></li>
            <li><a href="/contact">Contact</a></li>
            {% if request.session.user_id %}
            <li><a href="/usersapp/dashboard">Contul meu</a></li>
            <li><a href="/usersapp/logout">Deconectare</a></li>
        {% else %}
            <li><a href="/usersapp/login">Autentificare</a></li>
        {% endif %}
        </ul>
    </nav>
</header>



<section class="dashboard-section">
    <div class="container">
        <h1>Profil utilizator</h1>
        <form method="post" action="">
            {% csrf_token %}

            <label for="nume">Nume</label>
            <input type="text" id="nume" name="nume" value="{{ user.nume }}" required>

            <label for="prenume">Prenume</label>
            <input type="text" id="prenume" name="prenume" value="{{ user.prenume }}" required>

            <label for="email">Email</label>
            <input type="email" id="email" name="email" value="{{ user.email }}" required>

            <label for="parola">ParolÄƒ</label>
            <input type="password" id="parola" name="parola" value="{{ user.parola }}" required>

            <label for="tip_persoana">Tip persoanÄƒ</label>
            <input type="text" id="tip_persoana" name="tip_persoana" value="{{ user.tip_persoana }}" disabled>

            {% if user.tip_persoana == 'JuridicÄƒ' %}
                <label for="companie">Nume companie</label>
                <input type="text" id="companie" name="companie" value="{{ user.companie }}">
            {% endif %}

            {% if user_not_has_map_access %}
            <label for="adresa">AdresÄƒ</label>
            <input type="text" id="adresa" name="adresa" value="{{ user.adresa }}">

            <div class="status-cos">
                <label>Status coÈ™ reciclare:</label>
                <button type="button" id="toggleStatus" class="{% if user.status_cos %}plin{% else %}gol{% endif %}">
                    {% if user.status_cos %}
                        Container plin â€“ gata de colectat
                    {% else %}
                        Container gol
                    {% endif %}
                </button>
                
                <input type="hidden" name="status_cos" id="status_cos" value="{{ user.status_cos|yesno:'true,false' }}">
            </div>
            {% if messages %}
                {% for message in messages %}
                    <p style="color: green; font-weight: bold; margin-top: 30px;">{{ message }}</p>
                {% endfor %}
            {% endif %}
            <div id="harta"
                data-lat="{{ user.lat|default_if_none:'' }}"
                data-lon="{{ user.lon|default_if_none:'' }}"
                style="height: 400px; width: 100%; border-radius: 12px; margin-top: 30px;">
            </div>
            <div class="form-buttons">
                <button type="submit">SalveazÄƒ modificÄƒrile</button>
            </div>
            {% endif %}

            {% if user_has_map_access %}
            <h2 style="margin-top: 60px;">Harta tuturor cosurilor</h2>
            <div id="map-all-users" style="width: 100%; height: 500px; margin-bottom: 50px; border-radius: 12px;"></div>

            <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCU6xG5LXFTZbcccWOAiex1cQtfTghEbrI"></script>
            <script>
                function initGlobalMap() {
                    var center = {lat: 45.9432, lng: 24.9668};  // RomÃ¢nia
                    var map = new google.maps.Map(document.getElementById('map-all-users'), {
                        zoom: 6,
                        center: center
                    });

                    var markers = JSON.parse('{{ all_user_locations|escapejs }}');

                    markers.forEach(function(marker) {
                        var position = {
                            lat: parseFloat(marker.lat),
                            lng: parseFloat(marker.lon)
                        };

                        var infoContent = `<strong>${marker.name}</strong><br>${marker.adresa}`;

                        var infowindow = new google.maps.InfoWindow({
                            content: infoContent
                        });


                        // Alegem culoarea markerului Ã®n funcÈ›ie de status_cos
                        const iconUrl = marker.status_cos
                            ? "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                            : "http://maps.google.com/mapfiles/ms/icons/red-dot.png";

                        var gMarker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: marker.name,
                            icon: {
                                url: iconUrl
                            }
                        });

                        gMarker.addListener('click', function () {
                            infowindow.open(map, gMarker);
                        });
                    });
                }

                document.addEventListener("DOMContentLoaded", function () {
                    if (document.getElementById("map-all-users")) {
                        initGlobalMap();
                    }
                });
            </script>
            {% endif %}

        </form>
    </div>
</section>
</body>
</html>